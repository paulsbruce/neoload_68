name: NeoLoadAsCode
includes:
- yaml/user_paths/api_savedsearch.yaml
- yaml/scenarios/dynAPISanityCheck.yaml

variables:
- constant:
    name: app_server_hostname # useful for overriding by CLI per environment
    value: ushahidi # default
- file:
    name: cities
    column_names: ["City"]
    is_first_line_column_names: false
    start_from_line: 1
    delimiter: ","
    path: custom-resources/cities.csv
    change_policy: each_iteration
    scope: global
    order: any
    out_of_value: cycle

servers:
- name: app_server
  host: ${app_server_hostname}
  scheme: http
- name: external_maps
  host: nominatim.openstreetmap.org
  scheme: https
  port: 443

sla_profiles:
- name: sla_internal_api_calls
  thresholds:
  - avg-request-resp-time warn >= 500ms fail >= 1s per test
  - perc-transaction-resp-time (p95) warn >= 300ms fail >= 1200ms per test
  - error-rate warn >= 5% per interval
- name: sla_external_api_calls
  thresholds:
  - avg-request-resp-time warn >= 500ms fail >= 1s per test
  - perc-transaction-resp-time (p95) warn >= 10s fail >= 20s per test
  - error-rate warn >= 5% per interval
- name: sla_static_resources
  thresholds:
  - avg-resp-time warn >= 500ms fail >= 1000ms per interval

user_paths:
- name: geo_search
  actions:
    steps:
    - transaction:
        name: Geo Search Call
        steps:
        - delay: 1s
        - request:
            url: /search?format=json&q=${cities.City}
            server: external_maps
            method: GET
            sla_profile: sla_dynamic_api_calls

  # additional ;user paths from includes

populations:
- name: API
  user_paths:
  - name: geo_search
    distribution: 50%
  - name: api_savedsearch
    distribution: 50%
- name: API_just_ushahidi
  user_paths:
  - name: api_savedsearch
    distribution: 100%

scenarios:
- name: MixedScenarioWithMonitoring
  populations:
  - name: API_just_ushahidi
    rampup_load:
      duration: 5m
      min_users: 1
      max_users: 5
      increment_users: 1
      increment_every: 10s
  - name: popPost
    rampup_load:
      duration: 5m
      min_users: 1
      max_users: 15
      increment_users: 1
      increment_every: 15s
  - name: dynatracePop
    constant_load:
      duration: 5m
      users: 1
